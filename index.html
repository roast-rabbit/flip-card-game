<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
    <title>Document</title>
  </head>
  <body>
    <div class="emoji_card_list pages game_content">
      <div id="game-stats">
        <div id="time-remaining">time remaining: <span></span></div>
        <div id="current-level">LEVEL: <span></span></div>
      </div>
      <section class="game__cards js-cards">
        <div id="message">
          <p id="message-info"></p>
          <button id="action-btn">action-btn😘</button>
        </div>
        <div id="overlay"></div>
        <div class="game__card js-card" data-animal="dog" style="order: 5">
          <div class="game__back-card">
            <i class="emoji_font">🙈</i>
          </div>
          <div class="game__front-card">
            <i class="emoji_font">😂</i>
          </div>
        </div>
        <div class="game__card js-card" data-animal="rabbit" style="order: 17">
          <div class="game__back-card">
            <i class="emoji_font">🙈</i>
          </div>
          <div class="game__front-card">
            <i class="emoji_font">😈</i>
          </div>
        </div>
        <div class="game__card js-card" data-animal="monkey" style="order: 15">
          <div class="game__back-card">
            <i class="emoji_font">🙈</i>
          </div>
          <div class="game__front-card">
            <i class="emoji_font">😤</i>
          </div>
        </div>
        <div class="game__card js-card" data-animal="lion" style="order: 16">
          <div class="game__back-card">
            <i class="emoji_font">🙈</i>
          </div>
          <div class="game__front-card">
            <i class="emoji_font">👽</i>
          </div>
        </div>
        <div class="game__card js-card" data-animal="bear" style="order: 13">
          <div class="game__back-card">
            <i class="emoji_font">🙈</i>
          </div>
          <div class="game__front-card">
            <i class="emoji_font">😃</i>
          </div>
        </div>
        <div class="game__card js-card" data-animal="pig" style="order: 2">
          <div class="game__back-card">
            <i class="emoji_font">🙈</i>
          </div>
          <div class="game__front-card">
            <i class="emoji_font">😍</i>
          </div>
        </div>
        <div class="game__card js-card" data-animal="monkey" style="order: 20">
          <div class="game__back-card">
            <i class="emoji_font">🙈</i>
          </div>
          <div class="game__front-card">
            <i class="emoji_font">😤</i>
          </div>
        </div>
        <div class="game__card js-card" data-animal="dog" style="order: 20">
          <div class="game__back-card">
            <i class="emoji_font">🙈</i>
          </div>
          <div class="game__front-card">
            <i class="emoji_font">😂</i>
          </div>
        </div>
        <div class="game__card js-card" data-animal="panda" style="order: 16">
          <div class="game__back-card">
            <i class="emoji_font">🙈</i>
          </div>
          <div class="game__front-card">
            <i class="emoji_font">🤠</i>
          </div>
        </div>
        <div class="game__card js-card" data-animal="pig" style="order: 19">
          <div class="game__back-card">
            <i class="emoji_font">🙈</i>
          </div>
          <div class="game__front-card">
            <i class="emoji_font">😍</i>
          </div>
        </div>
        <div class="game__card js-card" data-animal="fox" style="order: 12">
          <div class="game__back-card">
            <i class="emoji_font">🙈</i>
          </div>
          <div class="game__front-card">
            <i class="emoji_font">😱</i>
          </div>
        </div>
        <div class="game__card js-card" data-animal="owl" style="order: 16">
          <div class="game__back-card">
            <i class="emoji_font">🙈</i>
          </div>
          <div class="game__front-card">
            <i class="emoji_font">💩</i>
          </div>
        </div>
        <div class="game__card js-card" data-animal="owl" style="order: 14">
          <div class="game__back-card">
            <i class="emoji_font">🙈</i>
          </div>
          <div class="game__front-card">
            <i class="emoji_font">💩</i>
          </div>
        </div>
        <div class="game__card js-card" data-animal="lion" style="order: 1">
          <div class="game__back-card">
            <i class="emoji_font">🙈</i>
          </div>
          <div class="game__front-card">
            <i class="emoji_font">👽</i>
          </div>
        </div>
        <div class="game__card js-card" data-animal="cat" style="order: 1">
          <div class="game__back-card">
            <i class="emoji_font">🙈</i>
          </div>
          <div class="game__front-card">
            <i class="emoji_font">🙃</i>
          </div>
        </div>
        <div class="game__card js-card" data-animal="cat" style="order: 11">
          <div class="game__back-card">
            <i class="emoji_font">🙈</i>
          </div>
          <div class="game__front-card">
            <i class="emoji_font">🙃</i>
          </div>
        </div>
        <div class="game__card js-card" data-animal="panda" style="order: 17">
          <div class="game__back-card">
            <i class="emoji_font">🙈</i>
          </div>
          <div class="game__front-card">
            <i class="emoji_font">🤠</i>
          </div>
        </div>
        <div class="game__card js-card" data-animal="fox" style="order: 13">
          <div class="game__back-card">
            <i class="emoji_font">🙈</i>
          </div>
          <div class="game__front-card">
            <i class="emoji_font">😱</i>
          </div>
        </div>
        <div class="game__card js-card" data-animal="rabbit" style="order: 16">
          <div class="game__back-card">
            <i class="emoji_font">🙈</i>
          </div>
          <div class="game__front-card">
            <i class="emoji_font">😈</i>
          </div>
        </div>
        <div class="game__card js-card" data-animal="bear" style="order: 17">
          <div class="game__back-card">
            <i class="emoji_font">🙈</i>
          </div>
          <div class="game__front-card">
            <i class="emoji_font">😃</i>
          </div>
        </div>
      </section>
      <style>
        svg {
          display: block;
        }
        .game {
          min-width: 575px;
          height: 100vh;
          background: #2f4274;
          display: flex;
          align-items: center;
          justify-content: center;
        }
        #game-stats {
          display: flex;
          padding: 1rem;
          gap: 2rem;
        }
        .game__cards {
          position: relative;
          width: 100%;
          margin: auto;
          display: grid;
          grid-template-columns: repeat(5, 1fr);
          grid-auto-rows: 100px;
          grid-gap: 0.5rem;
          padding: 0.5rem;
        }
        .game__cards.no-event {
          pointer-events: none;
        }
        .game__card.no-event {
          pointer-events: none;
        }
        .game__card {
          position: relative;
          cursor: pointer;
          -webkit-perspective: 700px;
          perspective: 700px;
        }
        .game__card.flipped,
        .game__card.has-match {
          pointer-events: none;
        }
        .game__card.flipped .game__back-card,
        .game__card.has-match .game__back-card {
          -webkit-transform: rotateY(180deg);
          transform: rotateY(180deg);
        }
        .game__card.flipped .game__front-card,
        .game__card.has-match .game__front-card {
          -webkit-transform: rotateY(360deg);
          transform: rotateY(360deg);
        }
        .game__back-card,
        .game__front-card {
          position: absolute;
          top: 0;
          bottom: 0;
          right: 0;
          left: 0;
          background: #f27922;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: 10px;
          -webkit-backface-visibility: hidden;
          backface-visibility: hidden;
          transition: -webkit-transform 400ms;
          transition: transform 400ms;
          transition: transform 400ms, -webkit-transform 400ms;
        }
        .game__back-card {
          z-index: 1;
          background-color: #888da8;
        }
        .game__back-card .emoji_font,
        .game__front-card .emoji_font {
          font-size: 40px;
          margin-right: 0;
        }
        .game__front-card {
          -webkit-transform: rotateY(180deg);
          transform: rotateY(180deg);
        }
        #message {
          font-size: 2rem;
          width: 60%;
          background-color: rgb(51 51 51 / 70%);
          color: #ddd;
          opacity: 90%;
          padding: 2rem;
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          border-radius: 10px;
          display: none;
          z-index: 10;
          backdrop-filter: blur(10px);
          -webkit-backdrop-filter: blur(10px);
        }
        #message.shown {
          display: block;
        }
        #message #action-btn {
          cursor: pointer;
          background-color: #ccc;
          border-radius: 10px;
          font-size: 4vmin;
          padding: 2vmin;
        }

        #overlay {
          position: absolute;
          z-index: 5;
          opacity: 90%;
          background-color: rgba(0, 0, 0, 0.5);
          top: 0;
          left: 0;
          bottom: 0;
          right: 0;
          display: none;
        }
        #overlay.shown {
          display: block;
        }
      </style>
      <script type="text/javascript">
        class MemoryGame {
          // Time in second
          #time = 180;

          #level = 1;
          constructor() {
            this.duration = 1000;
            this.cardsContainer = document.querySelector(".js-cards");
            this.cards = Array.from(
              document.querySelectorAll(".game__card.js-card")
            );
            this.timeRemaining = document.querySelector("#time-remaining span");
            this.currentLevel = document.querySelector("#current-level span");
            this.finalMatchings = document.querySelector(
              "#lose-message p span"
            );
            this.message = document.querySelector("#message");
            this.overlay = document.querySelector("#overlay");
            this.actionBtn = document.querySelector("#action-btn");
            this.messageInfo = document.querySelector("#message-info");
          }

          init() {
            // this.#level = 1;
            this.shuffleCards();
            this.cards.forEach((card) => {
              card.classList.remove("flipped");
            });
            this.message.classList.remove("shown");
            this.overlay.classList.remove("shown");
            this.currentLevel.textContent = this.#level;
            clearInterval(this.timer);
            this.timer = this.startTimer();
          }

          shuffleCards() {
            this.cards.forEach((card) => {
              const randomNumber =
                Math.floor(Math.random() * this.cards.length) + 1;
              card.classList.remove("has-match");

              setTimeout(() => {
                card.style.order = `${randomNumber}`;
              }, 400);
            });
          }

          checkAllCards() {
            if (
              this.cards.every((card) => card.classList.contains("has-match"))
            ) {
              setTimeout(() => {
                this.#level++;
                this.message.classList.add("shown");
                this.overlay.classList.add("shown");
                this.messageInfo.textContent = `Enter level ${this.#level}`;
                this.actionBtn.textContent = "start";
                clearInterval(this.timer);
                this.#time += 60;
                this.actionBtn.addEventListener("click", () => {
                  this.init();
                });
              }, this.duration);
            }
          }

          stopEvent() {
            this.cardsContainer.classList.add("no-event");

            setTimeout(() => {
              this.cardsContainer.classList.remove("no-event");
            }, this.duration);
          }

          checkIfMatched(firstCard, secondCard) {
            if (firstCard.dataset.animal === secondCard.dataset.animal) {
              firstCard.classList.remove("flipped");
              secondCard.classList.remove("flipped");

              firstCard.classList.add("has-match");
              secondCard.classList.add("has-match");
              // this.#machingPairs++;
              // this.currentMatchings.textContent = this.#machingPairs;

              this.checkAllCards();
            } else {
              setTimeout(() => {
                firstCard.classList.remove("flipped");
                secondCard.classList.remove("flipped");
              }, this.duration);
            }
          }

          flip(selectedCard) {
            selectedCard.classList.add("flipped");

            const flippedCards = this.cards.filter((card) =>
              card.classList.contains("flipped")
            );

            if (flippedCards.length === 2) {
              this.stopEvent();
              this.checkIfMatched(flippedCards[0], flippedCards[1]);
            }
          }

          startTimer() {
            const tick = () => {
              const min = String(Math.trunc(this.#time / 60)).padStart(2, 0);
              const sec = String(this.#time % 60).padStart(2, 0);

              //In each call, print the remaining time to UI
              this.timeRemaining.textContent = `${min}:${sec}`;
              // When 0 seconds, stop timer and end game
              if (this.#time === 0) {
                clearInterval(this.timer);
                setTimeout(() => {
                  this.timeRemaining.textContent = `GAME OVER`;

                  this.message.classList.add("shown");
                  this.overlay.classList.add("shown");
                  this.messageInfo.textContent = "Time out";
                  this.actionBtn.textContent = "restart game";

                  this.actionBtn.addEventListener("click", startGame);
                }, 1000);
              } else {
                this.#time > 0 && this.#time--;
              }
            };

            this.#time > 0 && tick();
            const timer = setInterval(tick, 1000);
            timers.push(timer);
            return timer;
          }
        }
        const timers = [];
        let game;
        function startGame() {
          console.log(`before clearing timer: ${timers}`);
          timers.forEach((timer) => {
            clearInterval(timer);
          });
          console.log(`After clearing timer ${timers}`);
          game = new MemoryGame();
          console.log(game);
          game.init();

          Array.from(document.querySelectorAll(".js-card")).forEach((card) => {
            card.addEventListener("click", game.flip.bind(game, card));
          });
        }

        startGame();
      </script>
    </div>
  </body>
</html>
